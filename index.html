<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årbol Geneal√≥gico Familiar</title>
    <style>
        /* ===== RESET Y BASE ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    color: #333;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* ===== HEADER ===== */
header {
    text-align: center;
    margin-bottom: 2rem;
}

header h1 {
    color: white;
    font-size: 2.5rem;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

/* ===== MENSAJES ===== */
.message {
    padding: 1rem;
    margin: 1rem 0;
    border-radius: 8px;
    font-weight: 500;
    text-align: center;
    animation: slideDown 0.3s ease-out;
}

.message.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.message.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.message.info {
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

/* ===== SECCI√ìN DE AUTENTICACI√ìN ===== */
.auth-section {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 60vh;
}

.auth-card {
    background: white;
    padding: 2.5rem;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    width: 100%;
    max-width: 450px;
}

.auth-card h2 {
    text-align: center;
    margin-bottom: 2rem;
    color: #4a5568;
    font-size: 1.8rem;
}

/* ===== FORMULARIOS ===== */
.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #4a5568;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 0.8rem;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

/* ===== BOTONES ===== */
button {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: none;
}

button[type="submit"],
.save-btn,
.load-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

button[type="submit"]:hover,
.save-btn:hover,
.load-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

button[type="button"] {
    background: #f7fafc;
    color: #4a5568;
    border: 2px solid #e2e8f0;
}

button[type="button"]:hover {
    background: #edf2f7;
    border-color: #cbd5e0;
}

.logout-btn {
    background: #fed7d7;
    color: #c53030;
    border: 2px solid #feb2b2;
}

.logout-btn:hover {
    background: #feb2b2;
}

.delete-btn {
    background: #fed7d7;
    color: #c53030;
    padding: 0.4rem 0.8rem;
    font-size: 0.9rem;
    border: 1px solid #feb2b2;
}

.delete-btn:hover {
    background: #feb2b2;
}

.add-btn {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
    width: 100%;
}

.add-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
}

.form-actions button {
    flex: 1;
}

/* ===== TEXTO DE AYUDA ===== */
.help-text {
    margin-top: 2rem;
    padding: 1.5rem;
    background: #f7fafc;
    border-radius: 8px;
    border-left: 4px solid #667eea;
}

.help-text p {
    margin-bottom: 0.5rem;
    color: #4a5568;
}

.help-text ul {
    list-style: none;
    padding-left: 1rem;
}

.help-text li {
    color: #667eea;
    font-weight: 500;
    margin-bottom: 0.3rem;
}

.help-text li::before {
    content: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ";
    margin-right: 0.5rem;
}

/* ===== SECCI√ìN DEL √ÅRBOL ===== */
.tree-section {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin-top: 2rem;
}

.tree-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.tree-header h2 {
    color: #4a5568;
    font-size: 1.8rem;
}

.tree-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

/* ===== SECCI√ìN AGREGAR MIEMBRO ===== */
.add-member-section {
    background: #f7fafc;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    border: 2px solid #e2e8f0;
}

.add-member-section h3 {
    color: #4a5568;
    margin-bottom: 1.5rem;
    font-size: 1.4rem;
}

/* ===== ESTAD√çSTICAS ===== */
.stats-section {
    margin-bottom: 2rem;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    text-align: center;
    font-weight: 600;
    font-size: 1.1rem;
    display: inline-block;
}

/* ===== VISUALIZACI√ìN DEL √ÅRBOL ===== */
.tree-display h3 {
    color: #4a5568;
    margin-bottom: 1.5rem;
    font-size: 1.4rem;
}

.family-tree-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}

.member-card {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.member-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: #667eea;
}

.member-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #f1f5f9;
}

.member-header h3 {
    color: #2d3748;
    font-size: 1.3rem;
    margin: 0;
}

.member-info p {
    margin-bottom: 0.5rem;
    color: #4a5568;
}

.member-info strong {
    color: #2d3748;
}

.added-date {
    font-size: 0.9rem;
    color: #718096;
    font-style: italic;
    margin-top: 1rem;
    padding-top: 0.5rem;
    border-top: 1px solid #e2e8f0;
}

.no-members {
    text-align: center;
    padding: 3rem;
    color: #718096;
    background: #f7fafc;
    border-radius: 12px;
    border: 2px dashed #cbd5e0;
}

.no-members p {
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
}

/* ===== ANIMACIONES ===== */
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.member-card {
    animation: fadeIn 0.3s ease-out;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .container {
        padding: 1rem;
    }
    
    header h1 {
        font-size: 2rem;
    }
    
    .tree-header {
        flex-direction: column;
        text-align: center;
    }
    
    .tree-actions {
        justify-content: center;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .auth-card {
        padding: 1.5rem;
    }
    
    .family-tree-container {
        grid-template-columns: 1fr;
    }
    
    .add-member-section {
        padding: 1.5rem;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üå≥ √Årbol Geneal√≥gico Familiar</h1>
            <div id="message" class="message" style="display: none;"></div>
        </header>

        <!-- Secci√≥n de Autenticaci√≥n -->
        <section id="auth-section" class="auth-section">
            <div class="auth-card">
                <h2>üîê Acceso Familiar</h2>
                <form id="auth-form">
                    <div class="form-group">
                        <label for="familyId">ID de Familia:</label>
                        <input type="text" id="familyId" placeholder="familia_manrique" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Contrase√±a:</label>
                        <input type="password" id="password" placeholder="Contrase√±a familiar" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit">Ingresar</button>
                        <button type="button" onclick="testConnection()">Probar Conexi√≥n</button>
                    </div>
                </form>
                <div class="help-text">
                    <p>üí° <strong>Familias disponibles:</strong></p>
                    <ul>
                        <li>familia_manrique</li>
                        <li>familia_garcia</li>
                        <li>familia_lopez</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Secci√≥n del √Årbol Geneal√≥gico -->
        <section id="tree-section" class="tree-section" style="display: none;">
            <div class="tree-header">
                <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Gesti√≥n del √Årbol Familiar</h2>
                <div class="tree-actions">
                    <button onclick="saveTree()" class="save-btn">üíæ Guardar</button>
                    <button onclick="loadTree()" class="load-btn">üì• Cargar</button>
                    <button onclick="logout()" class="logout-btn">üö™ Salir</button>
                </div>
            </div>

            <!-- Formulario para agregar miembros -->
            <div class="add-member-section">
                <h3>‚ûï Agregar Nuevo Miembro</h3>
                <form id="member-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="memberName">Nombre Completo:</label>
                            <input type="text" id="memberName" placeholder="Nombre del familiar" required>
                        </div>
                        <div class="form-group">
                            <label for="memberRelation">Parentesco:</label>
                            <select id="memberRelation">
                                <option value="">Seleccionar parentesco</option>
                                <option value="padre">Padre</option>
                                <option value="madre">Madre</option>
                                <option value="hijo">Hijo</option>
                                <option value="hija">Hija</option>
                                <option value="hermano">Hermano</option>
                                <option value="hermana">Hermana</option>
                                <option value="abuelo">Abuelo</option>
                                <option value="abuela">Abuela</option>
                                <option value="nieto">Nieto</option>
                                <option value="nieta">Nieta</option>
                                <option value="tio">T√≠o</option>
                                <option value="tia">T√≠a</option>
                                <option value="primo">Primo</option>
                                <option value="prima">Prima</option>
                                <option value="esposo">Esposo</option>
                                <option value="esposa">Esposa</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="memberBirth">Fecha de Nacimiento:</label>
                            <input type="date" id="memberBirth">
                        </div>
                        <div class="form-group">
                            <label for="memberNotes">Notas adicionales:</label>
                            <input type="text" id="memberNotes" placeholder="Informaci√≥n adicional (opcional)">
                        </div>
                    </div>
                    <button type="submit" class="add-btn">üë§ Agregar Miembro</button>
                </form>
            </div>

            <!-- Estad√≠sticas -->
            <div class="stats-section">
                <div id="member-count" class="stat-card">Total de miembros: 0</div>
            </div>

            <!-- Visualizaci√≥n del √°rbol -->
            <div class="tree-display">
                <h3>üå≥ √Årbol Familiar</h3>
                <div id="family-tree" class="family-tree-container">
                    <!-- Los miembros se renderizan aqu√≠ din√°micamente -->
                </div>
            </div>
        </section>
    </div>
    <script>
        // Variables globales
        let familyTree = {};
        let currentFamilyId = '';
        let selectedPersonId = null;
        let editingPersonId = null;

        
// ===== CONFIGURACI√ìN =====
const API_URL = 'https://script.google.com/macros/s/AKfycbwRq6NsMov7ypBvK7ZFfamSkkyNbExA7itYwcx4ZXm3w1rfC04yEkzJ3GkMprE3aXyq/exec'; // Reemplaza con tu URL

// ===== VARIABLES GLOBALES =====
let currentFamily = null;
let currentPassword = null;
let familyTree = {};

// ===== FUNCIONES DE COMUNICACI√ìN CON BACKEND =====
async function callBackend(data) {
  try {
    console.log('üöÄ Enviando al backend:', data);
    
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    console.log('‚úÖ Respuesta del backend:', result);
    return result;
    
  } catch (error) {
    console.error('‚ùå Error en callBackend:', error);
    return { 
      success: false, 
      message: `Error de conexi√≥n: ${error.message}` 
    };
  }
}

// ===== FUNCIONES DE AUTENTICACI√ìN =====
async function authenticate() {
  const familyId = document.getElementById('familyId').value.trim();
  const password = document.getElementById('password').value.trim();
  
  if (!familyId || !password) {
    showMessage('‚ùå Por favor completa todos los campos', 'error');
    return;
  }
  
  showMessage('üîê Autenticando...', 'info');
  
  try {
    const result = await callBackend({
      action: 'authenticate',
      familyId: familyId,
      password: password
    });
    
    if (result.success) {
      currentFamily = familyId;
      currentPassword = password;
      
      showMessage('‚úÖ Autenticaci√≥n exitosa', 'success');
      showSection('tree-section');
      hideSection('auth-section');
      
      // Cargar √°rbol existente
      await loadTree();
      
    } else {
      showMessage(`‚ùå ${result.message}`, 'error');
    }
    
  } catch (error) {
    console.error('Error en authenticate:', error);
    showMessage('üîó Error de conexi√≥n: No se puede conectar al servidor. Verifica: 1. URL correcta 2. Apps Script desplegado 3. Permisos configurados', 'error');
  }
}

// ===== FUNCIONES DE GESTI√ìN DE √ÅRBOLES =====
async function saveTree() {
  if (!currentFamily || !currentPassword) {
    showMessage('‚ùå No hay sesi√≥n activa', 'error');
    return;
  }
  
  showMessage('üíæ Guardando √°rbol...', 'info');
  
  try {
    const result = await callBackend({
      action: 'saveTree',
      familyId: currentFamily,
      password: currentPassword,
      treeData: familyTree
    });
    
    if (result.success) {
      showMessage(`‚úÖ √Årbol guardado - ${result.data?.memberCount || 0} miembros`, 'success');
    } else {
      showMessage(`‚ùå Error guardando: ${result.message}`, 'error');
    }
    
  } catch (error) {
    console.error('Error en saveTree:', error);
    showMessage('‚ùå Error guardando el √°rbol', 'error');
  }
}

async function loadTree() {
  if (!currentFamily || !currentPassword) {
    showMessage('‚ùå No hay sesi√≥n activa', 'error');
    return;
  }
  
  showMessage('üì• Cargando √°rbol...', 'info');
  
  try {
    const result = await callBackend({
      action: 'loadTree',
      familyId: currentFamily,
      password: currentPassword
    });
    
    if (result.success) {
      familyTree = result.data?.treeData || {};
      const memberCount = result.data?.memberCount || 0;
      const lastUpdate = result.data?.lastUpdate;
      
      showMessage(`‚úÖ √Årbol cargado - ${memberCount} miembros`, 'success');
      
      if (lastUpdate) {
        const date = new Date(lastUpdate).toLocaleString();
        showMessage(`üìÖ √öltima actualizaci√≥n: ${date}`, 'info');
      }
      
      renderTree();
    } else {
      showMessage(`‚ùå Error cargando: ${result.message}`, 'error');
    }
    
  } catch (error) {
    console.error('Error en loadTree:', error);
    showMessage('‚ùå Error cargando el √°rbol', 'error');
  }
}

// ===== FUNCIONES DE TEST =====
async function testConnection() {
  showMessage('üß™ Probando conexi√≥n...', 'info');
  
  try {
    const result = await callBackend({
      action: 'test'
    });
    
    if (result.success) {
      showMessage('‚úÖ Conexi√≥n exitosa con el backend', 'success');
      console.log('Test result:', result);
    } else {
      showMessage(`‚ùå Test fall√≥: ${result.message}`, 'error');
    }
    
  } catch (error) {
    console.error('Error en testConnection:', error);
    showMessage('‚ùå No se puede conectar al backend. Verifica la URL y configuraci√≥n.', 'error');
  }
}

// ===== FUNCIONES DE GESTI√ìN DE MIEMBROS =====
function addMember() {
  const name = document.getElementById('memberName').value.trim();
  const relation = document.getElementById('memberRelation').value;
  const birth = document.getElementById('memberBirth').value;
  const notes = document.getElementById('memberNotes').value.trim();
  
  if (!name) {
    showMessage('‚ùå El nombre es obligatorio', 'error');
    return;
  }
  
  const memberId = generateId();
  familyTree[memberId] = {
    id: memberId,
    name: name,
    relation: relation,
    birthDate: birth,
    notes: notes,
    addedDate: new Date().toISOString()
  };
  
  // Limpiar formulario
  document.getElementById('memberName').value = '';
  document.getElementById('memberRelation').value = '';
  document.getElementById('memberBirth').value = '';
  document.getElementById('memberNotes').value = '';
  
  showMessage(`‚úÖ ${name} agregado al √°rbol`, 'success');
  renderTree();
}

function deleteMember(memberId) {
  if (confirm('¬øEst√°s seguro de eliminar este miembro?')) {
    const memberName = familyTree[memberId]?.name || 'Miembro';
    delete familyTree[memberId];
    showMessage(`üóëÔ∏è ${memberName} eliminado`, 'info');
    renderTree();
  }
}

// ===== FUNCIONES DE RENDERIZADO =====
function renderTree() {
  const container = document.getElementById('family-tree');
  
  if (!container) {
    console.error('No se encontr√≥ el contenedor family-tree');
    return;
  }
  
  const members = Object.values(familyTree);
  
  if (members.length === 0) {
    container.innerHTML = `
      <div class="no-members">
        <p>üå± No hay miembros en el √°rbol familiar</p>
        <p>Agrega el primer miembro usando el formulario de arriba</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = members.map(member => `
    <div class="member-card" data-id="${member.id}">
      <div class="member-header">
        <h3>${member.name}</h3>
        <button onclick="deleteMember('${member.id}')" class="delete-btn">üóëÔ∏è</button>
      </div>
      <div class="member-info">
        <p><strong>Parentesco:</strong> ${member.relation || 'No especificado'}</p>
        ${member.birthDate ? `<p><strong>Nacimiento:</strong> ${member.birthDate}</p>` : ''}
        ${member.notes ? `<p><strong>Notas:</strong> ${member.notes}</p>` : ''}
        <p class="added-date">Agregado: ${new Date(member.addedDate).toLocaleDateString()}</p>
      </div>
    </div>
  `).join('');
  
  updateMemberCount();
}

// ===== FUNCIONES AUXILIARES =====
function generateId() {
  return 'member_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function showMessage(message, type = 'info') {
  const messageDiv = document.getElementById('message');
  if (!messageDiv) return;
  
  messageDiv.textContent = message;
  messageDiv.className = `message ${type}`;
  messageDiv.style.display = 'block';
  
  // Auto-ocultar despu√©s de 5 segundos para mensajes de √©xito e info
  if (type === 'success' || type === 'info') {
    setTimeout(() => {
      messageDiv.style.display = 'none';
    }, 5000);
  }
}

function showSection(sectionId) {
  const section = document.getElementById(sectionId);
  if (section) {
    section.style.display = 'block';
  }
}

function hideSection(sectionId) {
  const section = document.getElementById(sectionId);
  if (section) {
    section.style.display = 'none';
  }
}

function updateMemberCount() {
  const count = Object.keys(familyTree).length;
  const countElement = document.getElementById('member-count');
  if (countElement) {
    countElement.textContent = `Total de miembros: ${count}`;
  }
}

function logout() {
  if (confirm('¬øEst√°s seguro de cerrar sesi√≥n?')) {
    currentFamily = null;
    currentPassword = null;
    familyTree = {};
    
    showSection('auth-section');
    hideSection('tree-section');
    
    // Limpiar formularios
    document.getElementById('familyId').value = '';
    document.getElementById('password').value = '';
    
    showMessage('üëã Sesi√≥n cerrada', 'info');
    
    // Limpiar el √°rbol renderizado
    const container = document.getElementById('family-tree');
    if (container) {
      container.innerHTML = '';
    }
  }
}

// ===== EVENTOS Y INICIALIZACI√ìN =====
document.addEventListener('DOMContentLoaded', function() {
  console.log('üå≥ Aplicaci√≥n de √Årbol Geneal√≥gico iniciada');
  
  // Verificar que la URL del API est√© configurada
  if (API_URL === 'TU_URL_DE_GOOGLE_APPS_SCRIPT_AQU√ç') {
    showMessage('‚ö†Ô∏è Configuraci√≥n pendiente: Actualiza la URL del API en el script', 'error');
  }
  
  // Event listeners para formularios
  const authForm = document.getElementById('auth-form');
  if (authForm) {
    authForm.addEventListener('submit', function(e) {
      e.preventDefault();
      authenticate();
    });
  }
  
  const memberForm = document.getElementById('member-form');
  if (memberForm) {
    memberForm.addEventListener('submit', function(e) {
      e.preventDefault();
      addMember();
    });
  }
  
  // Manejar Enter en campos de texto
  const inputs = document.querySelectorAll('input[type="text"], input[type="password"]');
  inputs.forEach(input => {
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (input.closest('#auth-form')) {
          authenticate();
        } else if (input.closest('#member-form')) {
          addMember();
        }
      }
    });
  });
  
  console.log('‚úÖ Event listeners configurados');
});

// ===== FUNCIONES GLOBALES PARA BOTONES HTML =====
window.authenticate = authenticate;
window.testConnection = testConnection;
window.saveTree = saveTree;
window.loadTree = loadTree;
window.addMember = addMember;
window.deleteMember = deleteMember;
window.logout = logout;

        
        function resetView() {
            renderTree();
            updateStats();
        }

        // Auto-guardado cada 5 minutos
        setInterval(() => {
            if (currentFamilyId && Object.keys(familyTree).length > 0) {
                saveTreeToCloud();
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
